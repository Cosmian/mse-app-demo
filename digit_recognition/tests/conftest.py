"""Conftest."""

import os
import tempfile
from pathlib import Path
from typing import Union

import pytest
from cryptography import x509
from intel_sgx_ra.ratls import get_server_certificate


@pytest.fixture(scope="module")
def url() -> str:
    """Get the url of the mse app."""
    return os.getenv("TEST_REMOTE_URL", "http://localhost:5000/")


@pytest.fixture(scope="module")
def workspace() -> Path:
    """Get the path of the test work directory."""
    return Path(tempfile.mkdtemp())


@pytest.fixture(scope="module")
def certificate(url, workspace) -> Union[Path, bool]:
    """Get the mse app certificate."""
    if "https" not in url:
        return False  # Do not check

    if "localhost" in url:
        return False  # Do not check

    hostname = url.split("https://")[-1]
    cert_path: Path = workspace / "cert.pem"

    if cert_path.exists():
        if cert_path.read_text() == "1":
            return True  # Use the ssl bundle from the system
        return cert_path  # Use this specific bundle

    pem = get_server_certificate((hostname, 443))
    cert = x509.load_pem_x509_certificate(pem.encode("utf8"))
    if cert.subject == cert.issuer:  # self signed certificate
        # save it for future use
        cert_path.write_bytes(pem.encode("utf-8"))
    else:
        cert_path.write_text("1")
        return True

    return cert_path


@pytest.fixture(scope="module")
def data() -> str:
    """Get test data."""
    return "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAc4ElEQVR4Xu2dC6wWxfmHXw7XoyJgi4JyLRApKqAphotWMERtoQVqNb0pEDFKECzVKKgIljQWReUmkLYqqEUbajhapJySKIqoRAMHIq1GkEvkUlQERO5CfffP8R+Vw+73fTuzMzvPJETMN/tennf4ZXd2dqaWiBz78g8NAhCAgPMEaiFYzteIACEAgeMEECyGAgQg4A0BBMubUhEoBCCAYDEGIAABbwggWN6UikAhAAEEizEAAQh4QwDB8qZUBAoBCCBYjAEIQMAbAgiWN6UiUAhAAMFiDEAAAt4QQLC8KRWBQgACCBZjAAIQ8IYAguVNqQgUAhBAsBgDEICANwQQLG9KRaAQgACCxRiAAAS8IYBgeVMqAoUABBAsxgAEIOANAQTLm1IRKAQggGAxBiAAAW8IIFjelIpAIQABBIsxAAEIeEMAwfKmVAQKAQggWIwBCEDAGwIIljelIlAIQADBYgxAAALeEECwvCkVgUIAAggWYwACEPCGAILlTakIFAIQQLAYAxCAgDcEECxvSkWgEIAAgsUYgAAEvCGAYHlTKgKFAAQQLMYABCDgDQEEy5tSESgEIIBgMQYgAAFvCCBY3pQq20C7du0qV155pVxyySXy2WefycUXXyy1atWSzz//XPbu3SuHDh36KsB69epJw4YNpUGDBrJu3TrZs2dP9P8rV66UN954Q9555x3ZtGlTtgnh3UsCCJaXZSs86G7duslPf/pTadu2rfTu3TsyoIJz9OhR2bdvXyQ4Bw4ciETmnHPOkSNHjkh5eXn0/3Xq1CncYYIrDh8+LPrn4MGDUQwqbPPmzZOFCxdKVVVVAgt0CY0AgpXzir/wwgvSp08fOe2007zK9NixY7J9+3Z55plnZNq0adyReVU9c8EiWObYZmr5sccek+uuu07q1q2baRxpOde7r1WrVsn8+fPl0UcfTcssdjwjgGB5VrAk4eo8Uffu3ZN09bKP3n2pgOlc2IwZM+TZZ5/1Mg+CLpwAglU4M6ev2L17t5x++ulOx5h2cDr/tWDBAhkyZEg090bLLwEEK0e1XbFiRfT2LtSmYrV8+fKvXiqEyiHPeSNYOanuww8/LKNHj85JNqWloW87R40aJX/+859LM8TVzhFAsJwrSeEB6RopnZCmfZ2ALo348Y9/LNu2bQNNTgggWDko5JIlS6Rv3745yCT9FHSd2V//+le5/vrr0zeOResEECzryNN12LFjR/nPf/6TrtEcWtu1a5fccccdPCZ6XlsEy/MC3nbbbTJ58mTPs7AX/pYtW0RX/fOYaI95mp4QrDRpZmBr2bJl0fd9tMIIzJw5U0aMGFHYRfTOnACClXkJSgvgww8/jL79oxVOQBfY9uzZs/ALuSIzAghWZujTcawfDuvuCLTiCOjcVpMmTYq7mKusE0CwrCNP1yGCVTrPnTt3yne+853SDWHBOAEEyzhisw4+/vhj/rGlgHjz5s3SunXrFCxhwiQBBMskXQu233rrLfnBD35gwVP+Xehmgx06dMh/oh5niGB5XDwN/b777pN7773X8yzcCR/RcqcWJ4oEwXK7PrHRsXA0FlHBHXbs2CFnnXVWwddxgXkCCJZ5xsY96F7pF154oXE/ITn49NNP5YwzzggpZS9yRbC8KNPJg+zRo4e8/vrrOcjErRR0b7HGjRu7FVTg0SBYORkAf/rTn+TGG2/MSTbupKFvYZs2bepOQIFHgmDlaADwxtBMMVnyYIZrMVYRrGKoOXxN6LuOmioNbw9NkS3MLoJVGC8vej/xxBPRiTm1a9dOPV7dhlh39CwrK4vOE9TdD/RACD1fsLrpST16cKp+46h96tevH51vqJ8QmTrjMPVET2Dwv//9rzRr1syGK3zUQADByunQaNmypfzjH/+QTp06xR71pafQ6GnO1acxn3rqqfL++++LfrKiwvPaa69JZWVlaoeb6ory888/XwYOHBjtv65zRI0aNfKiErw9zLZMCFa2/I17P++886JtggcNGhS98WrRokV02vPGjRuju6OKioroDePatWuNxxLnQLd7ueaaa6IlGi6f/KPHi11wwQVx6fC7AQIIlgGomCydgN6FjR07VgYPHhw9TrrWXnzxRenfv79rYeU+HgQr9yX2P0FdrvHAAw84tyZK71r1DpVmjwCCZY81nkok8OSTT8qvf/3raMLfhaZzfm3atHEhlGBiQLCCKXU+Em3evLksWrRI9GgzF5oebPHggw+6EEoQMSBYQZQ5f0nqY+KsWbOMLN0ohNb27dtFRZRmhwCCZYczXgwR0DVguvQiy/a9731PNmzYkGUIwfhGsIIpdX4T1TVj7du3zyxBfUTt169fZv5DcoxghVTtHOeapWh98cUXXq/g92lYIFg+VYtYT0pA39q1atUqE0rz5s2L3mDSzBJAsMzyxbplAh999JF897vftexVom8mXVzgah2EYYcIlmHAmLdPQM8azOLbRP0E6p///Kf9hAPyiGAFVOyQUtUPt20fkPr8889HH3TTzBFAsMyxxXLGBHSNlM3DJNid1HzBESzzjPGQIQHbbw9r1dJ/UjRTBBAsU2Sx6wwB3cPK1mES+m1h9b5izgDIUSAIVo6KSSo1E9A9wGzc/Vx//fXy1FNPUQpDBBAsQ2Ax6xYB3b9K3+KZbtOnT5dRo0aZdhOsfQQr2NKHlXjbtm3lgw8+MJ60HgLSvXt3435CdYBghVr5APPWxZ16EIbJxptCk3RFECyzfLHuEAHdi133uDfZ9FQhPTWIZoYAgmWGK1YdJDBt2jQZOXKk8chsTO4bT8JRBwiWo4UhrPQJ6FmNus2y6dalSxdZs2aNaTdB2kewgix7mEnrSTx6vJnpdvvtt8tDDz1k2k2Q9hGsIMsebtJ6aKzpph9A21hCYToPF+0jWC5WhZiMETh06JDxSfEDBw5IeXm5sRxCNoxghVz9AHPftm2bNGvWzHjmTLybQYxgmeGKVUcJVFZWyhVXXGE8uttuu00efvhh435Cc4BghVbxwPNVIZk8ebJxCgsXLpSf/OQnxv2E5gDBCq3igefbuXNnWb16tXEKulXzmWeeadxPaA4QrNAqTr5i400hK97NDDQEywxXrDpMwMb2ySqKZWVlDlPwMzQEy8+6EXUJBDZv3iwtW7YswUL8pQhWPKNieiBYxVDjGq8J7N69W04//XSjORw+fNj4zhBGE3DUOILlaGEIyxwBG7uPIlhm6odgmeGKVUcJdOrUSdauXWs8ui1btkiLFi2M+wnNAYIVWsUDz3f27Nly0003Gaegu0IMHjzYuJ/QHCBYoVU88Hx1m2TdLtl0+9GPfiSLFy827SY4+whWcCUPO2Eb81dKmG8JzYwzBMsMV6w6SED3qPrd735nPLIdO3ZYPXHaeEIOOUCwHCoGoZgj0LVrV3n77beldu3a5pwct7x+/Xpp3769cT8hOkCwQqx6YDn3799f5s+fLw0aNLCS+b333isTJ0604is0JwhWaBUPKF89Nv4Pf/iD/OpXv7KaNfNX5nAjWObYYjkjAo0bN5bx48fLb3/7W+sR7NmzRxo1amTdbygOEaxQKh1AnipUt956ayRU+vcsms6TdevWLQvXQfhEsIIoc/6THDdunOhpNaa/EYwjOXPmTBkxYkRcN34vkgCCVSQ4LnODwP333x8tVTB9BH3SbAcNGiQVFRVJu9OvQAIIVoHA6O4GAf3sRU9yzvqO6ps0mjRpIrt27XIDUg6jQLByWNQ8p6RCNWHCBNE3gK41Png2XxEEyzxjPKRAwGWhqk5v6NChMmfOnBSyxURNBBAsxobTBHwQKgW4detWOeecc5xmmYfgEKw8VDGHObjy1i8p2j59+sjSpUuTdqdfkQQQrCLBcVn6BHTt1J133unUW78kWd53333RvBrNPAEEyzxjPMQQ0Al0XfA5fPhwqV+/vle85s6dK0OGDPEqZp+DRbB8rp7nsffu3TsSqoEDB3qZiR7IqjmwjMFe+RAse6zx9CUBfewbMGCAs0sTkhZp06ZNolvWIFZJiaXTD8FKhyNWEj726eNTVt/5pVWk/fv3S8+ePaWqqiotk9hJSADBSgiKbsURuPvuu0XXJ7Vr1644Aw5exRvB7IqCYGXHPree9ZHv5ptvlr59+0qdOnVyleekSZNkzJgxucrJp2QQLJ+q5XCsKlI6ea5/fH/kqwnzqlWr5KKLLnK4CvkPDcHKf42NZagide2110q/fv1yv2ndW2+9JRdffLExlhhORgDBSsaJXscJDBs2TEaPHi0dO3aUsrKy3HM5duyYzJgxQ0aNGpX7XH1IEMHyoUoOxKj7TulOnrYOcnAgZVm3bp1cffXVsmbNGhfCIYYvCSBYDIMaCVR/KqN3VL6tQC+lrO+9957ceOONsmzZslLMcK0BAgiWAai+m9RPZfQQh9A+OdGV63oXyUfM7o5gBMvd2liL7LLLLpNOnTpFk8p5fstXE1Bdta4fL7OXlbUhV7QjBKtodP5eqIs59e1ehw4dpLy83N9ESoz84MGD8sc//pGdFkrkaPNyBMsm7Qx96ds9FSoXtxbOAsvzzz8fPfLyLWAW9Iv3iWAVz86LK//+979Hj3m1a9f2Il7TQf773/+WX/7yl7z5Mw3akH0EyxDYrM2OHTtWJk6ciFAdL8Ty5cvlN7/5jWzcuDHr0uC/BAIIVgnwXL1U33Z17tzZ1fCsxqUb7OmEOkJlFbsxZwiWMbT2Deu6KX3kad68uX3njnlEqBwrSErhIFgpgXTBjL6eb9WqlQuhZBYDQpUZeiuOESwrmM07WbBggbdbDadBhzmqNCi6bwPBcr9GsRG2bt1aNmzYILVqaTnDayxRCKfmCFYOar148WK58sorc5BJ8Snoh8rXXHMN2xYXj9CLKxEsL8p08iAPHz6cu509iynLkSNH5KGHHmJH0GLgeXINguVJoWoK85JLLmFXgW/A0Tel5513nueVJfwTEUCwPB8X99xzT7RAlPZ1Atu3b5fvf//7fHqTs4GBYHleUN0KRXdboH2bwObNm0VfSNDyQwDB8ryWCNbJC1hRUSGDBg3yvMqEX00AwfJ8LPCGML6AP/zhD5nni8fkRQ8Ey4sy1Ryk7pD5yCOPeJ6F2fCZzzLL16Z1BMsmbQO+eEuYDOrUqVOj7Y9pfhNAsPyuXxT93r175dRTT81BJmZT0LksndOi+UsAwfK3dl9F/pe//EVuuOGGHGRiNoVDhw7JWWedxVIHs5iNWkewjOK1Z1xXebOraDzvjz/+WJo2bRrfkR5OEkCwnCxL4UGxgDQ5s+nTp3OSc3JcTvVEsJwqR2nBsMQhGT89fr5t27ai+4fR/CKAYPlVr9hoq6qqpEuXLrH9Qu+wYsUK6d69e+gYvMsfwfKuZPEBpzkJr28gd+7cKatWrZJ//etf0RbMKopJj8fq3bt3FLCe3NO1a1fp1auXMztL6F0We73HjyeXeiBYLlUjxVh0fdaTTz4ZPfokbQcOHJCXXnpJ5s2bJ2vXrjW2t5SeB/j73/9eWrZsmTQ0I/1efvllufzyy43YxqgZAgiWGa7OWNWPf3U3h379+knDhg2juxvdmVTncfTN4p49e6K1SdrH9pyOHu46adIkOeOMMzLj1adPH9HvMWl+EECw/KhTbqPUk35mzpwZHW6aRVOxUtGi+UEAwfKjTrmPUh8TZ8yYkcmK/REjRkSiSXOfAILlfo2CiVAn5XVi3/bCzn379mUilMEUNsVEEawUYWKqdAI657Zy5Urr81qVlZVy1VVXlZ4AFowSQLCM4sV4MQT0TkuXUdhsLCa1Sbt4XwhW8ey40iCBLPb5YndSgwVNyTSClRJIzKRP4N1335Vzzz03fcM1WNRlHnXr1rXmD0eFE0CwCmfGFZYI6JKHTz75RMrKyix5lGi92qJFi6z5w1FhBBCswnjR2zKBadOmyciRI615XbJkiVxxxRXW/OGoMAIIVmG86J0BAT2Gvl27dlY86zeSTZo0seILJ4UTQLAKZ8YVlgnoB9T63Z+tduGFFxr7jtJWDnn1g2DltbI5y0vf4A0YMMBKVhxYYQVzUU4QrKKwcZFtAm3atJENGzZYcctjoRXMRTlBsIrCxkVZEJg1a5bcfPPNVlxz+KoVzAU7QbAKRsYFWRHQZQ56iISNwzbefPNN6dGjR1ap4rcGAggWQ8MrArb2rdcjwerXr+8VmxCCRbBCqHKOcrQ5l3XppZfKa6+9liN6/qeCYPlfw+AysLUui+PA3BtaCJZ7NSGiGAK2PozmZB33hiKC5V5NiCiGgK3HQt3jXn3R3CGAYLlTCyIpgMCWLVvk7LPPLuCK4rrqgR00dwggWO7UgkgKIKD7v+te7KYbn+mYJlyYfQSrMF70doSAnru4bNky49EMHTpU5syZY9wPDpIRQLCScaKXgwR0wz3Ti0hnz54tw4cPdzD7MENCsMKsey6ytrEj6fr166V9+/a54JWHJBCsPFQx0BwmTJgg48ePN549E+/GESd2gGAlRkVH1wgMHDhQFixYYDysX/ziF/K3v/3NuB8cxBNAsOIZ0cNRArbWYz366KNyyy23OEohrLAQrLDqnbts9+/fLw0aNDCa13vvvScdO3Y06gPjyQggWMk40ctRArqpn+nV6AcOHJDy8nJHCYQVFoIVVr1zl62t7WZYQOrG0EGw3KgDURRJ4J577pGJEycWeXXyy+666y65//77k19ATyMEECwjWDFqi0Dnzp1l9erVxt0xj2UccSIHCFYiTHRymcDBgwelXr16RkM8evSo8VX1RhPIiXEEKyeFDDkN3RW0V69exhFwjL1xxLEOEKxYRHRwncCQIUPkiSeeMB7m6NGjZcqUKcb94KBmAggWo8N7ArYWkL7yyiuip1DTsiOAYGXHHs8pEtDDTxs1apSixW+bQrCM4k1kHMFKhIlOrhOoqqqSLl26GA0TwTKKN5FxBCsRJjq5TqCiokIGDBhgNEz9AFo/hKZlRwDByo49nlMkoJPht956a4oWv21q0qRJMmbMGKM+MH5yAggWIyQXBGwI1tSpU0WPGKNlRwDByo49nlMkoPuuDx48OEWL3zY1d+5c0SUUtOwIIFjZscdzigSWLl0ql112WYoWv22KSXejeBMZR7ASYaKT6wQQLNcrlE58CFY6HLGSMQEb28xUVlbKVVddlXGmYbtHsMKuf26yZw4rN6U8aSIIVhh1zn2Wjz/+uOihpyYbZxSapJvMNoKVjBO9HCfAHZbjBUopPAQrJZCYyZYAk+7Z8rflHcGyRRo/RgkgWEbxOmMcwXKmFARSCgHeEpZCz59rESx/akWkJyHw/vvvS/v27Y0yeu655+TnP/+5UR8YPzkBBIsR4jUB3bzvjTfekGbNmhnPY9GiRaLbJNOyI4BgZccezyUQaNy4sYwfP97qx8h8mlNCwVK6FMFKCSRm7BF44IEHZNSoUVK/fn17Tr/0hGBZxX1CZwhW9jUgggQE9I7qzjvvlNtvv13q1KmT4Ir0u+gmgYMGDUrfMBYTE0CwEqOiYxYEdI5KN+YbPny49Tuqb+bLqTlZjICv+0Swsq8BEZyAgJ5Oo0I1cOBAZ/jonvFr1qxxJp4QA0GwQqy6oznrY5/uyz5hwgTROyuX2hdffJHZo6hLHLKOBcHKugL4j8RJ76Z0N08VLRfb5s2bpXXr1i6GFlRMCFZQ5XYr2bvvvjvaYaFdu3ZuBXaCaDiAwo0SIVhu1CGIKKof+YYNGybdu3f36hGL+Ss3hiiC5UYdchuFPu7pvJROors0gV4I8L1790rDhg0LuYS+hgggWIbAhmy2a9eu0YEQOielf/e9PfbYY6J3hbTsCSBY2dcgFxGoMOkxWz/72c+kVatWuchJkzhy5IjUrVs3N/n4ngiC5XsFM4pf56P0DmrEiBHStm1bqV27dkaRmHXLYlGzfAu1jmAVSizg/vqYp/NQ/fv3N76ViwuYV6xYEb0coLlDAMFypxbORVI9F6UipZPmIbVXX33V+MGsIfFMK1cEKy2SObCjb/Sq76JUoFxdxGka9fTp06PdIGjuEUCw3KuJlYhUmFSg9JFHH/F0A7ysdkGwknACJ4cPH44eeXWjPpqbBBAsN+uSWlTVwqTipHdN+l/XvtNLLdkSDO3YsUPOPfdc2bVrVwlWuNQ0AQTLNGHD9lV89Bu3aiHSO6bzzz9fzjzzTKlXr55h7/kwv27dOunQoUM+ksl5FgiWJwWuvlPSu6S+ffsiSCnU7ejRo6K7l44dOzYFa5iwQQDBskH5Sx+vv/666Pdop5xyiiWPuDkZgdWrV0fzVRs3bgSURwQQLMPFWrBggbff0BlGk4n5tWvXypgxY2ThwoWZ+MdpaQQQrNL4nfTqffv2SXl5uUEPmE5KYM+ePdGeW3PmzEl6Cf0cJIBgGSqK7lBZVlZmyDpmkxI4duyYvPDCC9FnRLwBTErN3X4IloHaHDp0iA9mDXAt1OSqVasioWIf9kLJudsfwUq5Nlu3bpXmzZunbBVzSQkcPHhQFi9eHB2wyoR6Umr+9EOwUqxVz549Zfny5SlaxFRSAvrWb8qUKcxRJQXmaT8EK8XC6RxJo0aNUrSIqTgCc+fOjURq6dKlcV35PQcEEKwUi6gTvDTzBHbv3v3V3RSPfeZ5u+QBwUqpGnoy8cyZM1OyhpkTEdD5QT1ph6UJ4Y4PBCul2rNANCWQJzCj3/qNGzdOnn32WXNOsOwFAQQrpTIxf5USyONmtm3bFm3zMnHiRNm0aVO6xrHmLQEEK6XSIVilgdR5qYqKimjyXP/LIs/SeOb1agQrpcqy/qpwkHrnVC1QKlI0CMQRQLDiCCX8nTmsZKBUpFScdOK8qqoq2UX0gsBxAghWSkOBt4Q1g9y5c6dMnjxZnnnmGVafpzTeQjWDYKVYedZh/R9MPXxUH5GXLFki06ZN41u+FMdY6KYQrBRHwLvvvhvtCx5ie+WVV76aNOdRL8QRYCdnBCtlzqHcZem3e9UT5nwWk/IgwlyNBBCslAeHboXco0ePlK1mb27v3r1SWVkpTz/9dCRULDvIviYhRoBgGah6HpY4qEBt375d9FGPeSgDgwSTRRFAsIrCFn+RLwtJ9dFOPyDWeSf9U/33+AzpAQH7BBAsg8xdmoRXAf3kk0/knXfekfnz54sexsDkuMHiY9oIAQTLCNb/N6rrs6ZOnWp8y2R9hNM/K1asEBVK3XVTGxPihguMeasEECxLuHU30scffzw6YbjYwyn04M/PPvtM9u/fHwkTd0qWiocbZwggWM6UgkAgAIE4AghWHCF+hwAEnCGAYDlTCgKBAATiCCBYcYT4HQIQcIYAguVMKQgEAhCII4BgxRHidwhAwBkCCJYzpSAQCEAgjgCCFUeI3yEAAWcIIFjOlIJAIACBOAIIVhwhfocABJwhgGA5UwoCgQAE4gggWHGE+B0CEHCGAILlTCkIBAIQiCOAYMUR4ncIQMAZAgiWM6UgEAhAII4AghVHiN8hAAFnCCBYzpSCQCAAgTgCCFYcIX6HAAScIYBgOVMKAoEABOIIIFhxhPgdAhBwhgCC5UwpCAQCEIgjgGDFEeJ3CEDAGQIIljOlIBAIQCCOAIIVR4jfIQABZwggWM6UgkAgAIE4AghWHCF+hwAEnCGAYDlTCgKBAATiCCBYcYT4HQIQcIYAguVMKQgEAhCII4BgxRHidwhAwBkCCJYzpSAQCEAgjgCCFUeI3yEAAWcIIFjOlIJAIACBOAIIVhwhfocABJwhgGA5UwoCgQAE4gggWHGE+B0CEHCGAILlTCkIBAIQiCOAYMUR4ncIQMAZAgiWM6UgEAhAII4AghVHiN8hAAFnCCBYzpSCQCAAgTgCCFYcIX6HAAScIYBgOVMKAoEABOIIIFhxhPgdAhBwhsD/AHtJDXnrzdfxAAAAAElFTkSuQmCC"
